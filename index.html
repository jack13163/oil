<!DOCTYPE html>
<html>
  <head>
    <title>原油调度图</title>
    <!--引用-->
    <script
      src="js/snap.svg.js"
      type="text/javascript"
      charset="utf-8"
    ></script>
  </head>

  <body>
    <svg id="svg" width="1200" height="700"></svg>
    <input id="button1" type="button" class="zxx_api_button" value="运行" />
    <script>
      var data = [
        "0.0002 0.0002 0 0.0048 0.0001 0 1.6000",
        "0.0002 0.0003 0.0048 0.0126 0.0002 0 2.6000",
        "0.0001 0.0005 0 0.0100 0.0003 0 2.5000",
        "0.0003 0.0006 0 0.0060 0.0005 0 1.5000",
        "0.0003 0.0007 0.0060 0.0128 0.0004 0 1.7000", //"0.0006 0.0008 0 0.0040 0.0006 0 2.5000",预备阶段
        "0.0006 0.0008 0.0040 0.0069 0.0006 0 1.8000",
        "0.0003 0.0008 0.0128 0.0200 0.0006 0 1.8000",
        "0.0004 0.0009 0 0.0035 0.0007 0 2.2000",
        "0.0004 0.0010 0.0035 0.0066 0.0008 0 1.9000",
        "0.0006 0.0001 0.0069 0.0116 0.0011 0.0003 2.0000",
        "0.0002 0.0001 0.0126 0.0186 0.0011 0.0002 2.0000",
        "0.0006 0.0002 0.0116 0.0182 0.0011 0.0003 2.7388",
        "0.0002 0.0002 0.0186 0.0268 0.0011 0.0002 2.7388",
        "0.0006 0.0003 0.0182 0.0258 0.0011 0.0001 3.1897",
        "0.0002 0.0003 0.0268 0.0363 0.0011 0.0002 3.1897",
        "0.0005 0.0004 0 0.0017 0.0004 0.0003 2.4000",
        "0.0001 0.0004 0.0100 0.0196 0.0004 0.0003 2.4000",
        "0.0005 0.0011 0.0017 0.0041 0.0008 0.0001 2.0000 ",
        "0.0004 0.0011 0.0066 0.0098 0.0008 0.0001 2.0000",
        "0.0005 0.0009 0.0041 0.0082 0.0008 0.0001 3.4000",
        "0.0004 0.0009 0.0098 0.0152 0.0008 0.0001 3.4000",
        "0.0005 0.0006 0.0082 0.0123 0.0008 0.0001 3.4000",
        "0.0001 0.0006 0.0196 0.0332 0.0008 0.0001 3.4000",
        "0.0005 0.0005 0.0123 0.0131 0.0008 0.0002 1.0055",
        "0.0001 0.0005 0.0332 0.0372 0.0008 0.0002 1.0055",
        "0.0005 0.0011 0.0131 0.0144 0.0008 0.0002 1.6122",
        "0.0004 0.0011 0.0152 0.0178 0.0008 0.0002 1.6122",
        "0.0005 0.0007 0.0144 0.0155 0.0008 0.0002 1.3878",
        "0.0004 0.0007 0.0178 0.0200 0.0008 0.0002 1.3878",
        "0.0005 0.0009 0.0155 0.0192 0.0009 0.0001 3.0747",
        "0.0004 0.0009 0.0200 0.0249 0.0009 0.0001 3.0747",
        "0.0005 0.0001 0.0192 0.0208 0.0010 0.0002 2.0000",
        "0.0003 0.0001 0.0200 0.0280 0.0010 0.0002 2.0000",
        "0.0005 0.0004 0.0208 0.0238 0.0009 0.0001 2.5000",
        "0.0004 0.0004 0.0249 0.0289 0.0009 0.0001 2.5000",
        "0.0005 0.0011 0.0238 0.0253 0.0009 0.0003 2.0000",
        "0.0004 0.0011 0.0289 0.0321 0.0009 0.0003 2.0000",
        "0.0005 0.0007 0.0253 0.0269 0.0010 0.0002 2.0000",
        "0.0003 0.0007 0.0280 0.0360 0.0010 0.0002 2.0000",
        "0.0005 0.0009 0.0269 0.0271 0.0010 0.0003 0.3055",
        "0.0003 0.0009 0.0360 0.0372 0.0010 0.0003 0.3055",
        "0.0005 0.0002 0.0271 0.0309 0.0009 0.0001 3.1891",
        "0.0004 0.0002 0.0321 0.0372 0.0009 0.0001 3.1891"
      ];

      var colors = [
        "#f05b72",
        "#905a3d",
        "#f58220",
        "#7fb80e",
        "#494e8f",
        "#aa363d",
        "#8552a1",
        "#aa2116",
        "#dea32c",
        "#73b9a2",
        "#ba8448",
        "#f15a22"
      ];

      //全局时间
      t = 0;

      //绘制储油罐
      function getFP(svg, x, y, width, height) {
        var d = 5; //塔口直径
        var len = 20; //塔口长度
        var t = 5; //塔的厚度
        var d1 = svg.paper.rect(x, y, width, height, 10).attr({
          fill: "grey"
        });
        var d2 = svg.paper
          .rect(x + t, y + t, width - 2 * t, height - 2 * t, 10)
          .attr({
            fill: "white"
          });
        var d3 = svg.paper
          .rect(x + t, y + t, width - 2 * t, height - 2 * t, 10)
          .attr({
            fill: "white"
          });
        var e = svg.paper
          .line(x + width / 2, y + height, x + width / 2, y + height + len)
          .attr({
            stroke: "#000",
            strokeWidth: 5
          });
        var tag = svg.paper.text(
          x + (width - d) / 2 + 10,
          y + height + 12,
          "  "
        );
        return svg.paper.g(d1, d2, d3, tag, e); // 注意这里元素的顺序是不一样的
      }

      //绘制油罐
      function getTank(svg, x, y, width, height) {
        var d = 5; //罐口直径
        var len = 20; //罐口长度
        var t = 5; //罐的厚度
        var c1 = svg.paper.rect(x, y, width, height, 10).attr({
          fill: "grey"
        });
        var c2 = svg.paper
          .rect(x + t, y + t, width - 2 * t, height - 2 * t, 10)
          .attr({
            fill: "white"
          });
        var c3 = svg.paper
          .rect(x + t, y + t, width - 2 * t, height - 2 * t, 10)
          .attr({
            fill: "white"
          });
        var l1 = svg.paper.line(x + width / 2, y - len, x + width / 2, y).attr({
          stroke: "#000",
          strokeWidth: d
        });
        var l2 = svg.paper
          .line(x + width / 2, y + height, x + width / 2, y + height + len)
          .attr({
            stroke: "#000",
            strokeWidth: d
          });
        var t1 = svg.paper.text(x + (width - d) / 2 + 10, y, "IN");
        var t2 = svg.paper.text(
          x + (width - d) / 2 + 10,
          y + height + 12,
          "OUT"
        );
        var circle1 = svg.paper.circle(
          x + (width - d) / 2 - 10,
          y + height + 9,
          7
        );
        var circle2 = svg.paper.circle(
          x + (width - d) / 2 - 10,
          y + height + 9,
          5
        );
        //设置信号灯的颜色
        circle1.attr({
          fill: "gray"
        });
        circle2.attr({
          fill: "black"
        });
        return svg.paper.g(c1, c2, c3, t1, t2, l1, l2, circle1, circle2); // 注意这里元素的顺序是不一样的
      }

      //绘制蒸馏塔
      function getDS(svg, x, y, width, height) {
        var d = 5; //塔口直径
        var len = 20; //塔口长度
        var t = 5; //塔的厚度
        var d1 = svg.paper.rect(x, y, width, height, 10).attr({
          fill: "grey"
        });
        var d2 = svg.paper
          .rect(x + t, y + t, width - 2 * t, height - 2 * t, 10)
          .attr({
            fill: "white"
          });
        var d3 = svg.paper
          .rect(x + t, y + t, width - 2 * t, height - 2 * t, 10)
          .attr({
            fill: "white"
          });
        var e = svg.paper.line(x + width / 2, y - len, x + width / 2, y).attr({
          stroke: "#000",
          strokeWidth: 5
        });
        var tag = svg.paper.text(x + (width - d) / 2 + 10, y, "IN");
        var circle1 = svg.paper
          .circle(x + (width - d) / 2 - 10, y - 8, 7)
          .attr({
            fill: "gray"
          });
        var circle2 = svg.paper
          .circle(x + (width - d) / 2 - 10, y - 8, 5)
          .attr({
            fill: "black"
          });
        return svg.paper.g(d1, d2, d3, tag, e, circle1, circle2); // 注意这里元素的顺序是不一样的
      }

      //绘制管道
      function getPipeline(svg, x, y, width, height) {
        var bus1 = svg.paper.line(x, y, x + width, y).attr({
          stroke: "#000",
          strokeWidth: 5
        });
        var bus2 = svg.paper
          .line(x + width / 2, y, x + width / 2, y + height)
          .attr({
            stroke: "#000",
            strokeWidth: 10
          });
        var bus3 = svg.paper.line(x, y + height, x + width, y + height).attr({
          stroke: "#000",
          strokeWidth: 5
        });
        return svg.paper.g(bus1, bus2, bus3);
      }

      //该方法主要是为了简化旋转操作
      function getRenderObject(svg, type, x, y, centX, centY) {
        var result = {};
        var width = (centX - x) * 2;
        var height = (centY - y) * 2;

        if (type == "tank") {
          result.element = getTank(svg, x, y, width, height);
        } else if (type == "ds") {
          result.element = getDS(svg, x, y, width, height);
        } else if (type == "pipe") {
          result.element = getPipeline(svg, x, y, width, height);
        } else if (type == "fp") {
          result.element = getFP(svg, x, y, width, height);
        }
        result.type = type;
        result.x = x;
        result.y = y;
        result.centX = x + width / 2;
        result.centY = y + height / 2;
        return result;
      }

      //复制对象(和原始对象重叠)
      function cloneRenderObject(svg, obj) {
        return getRenderObject(
          svg,
          obj.type,
          obj.x,
          obj.y,
          obj.centX,
          obj.centY
        ); //obj.element.clone();
      }

      //移动
      function moveRenderObject(obj, right, down) {
        var m = new Snap.Matrix();
        m.translate(obj.x + right, obj.y + down);
        obj.element.transform(m);
        obj.x = obj.x + right;
        obj.y = obj.y + down;
        obj.centX = obj.centX + right;
        obj.centY = obj.centY + down;
      }

      //按照类型查找对象
      function selectObjectsByType(collection, type) {
        var result = [];
        for (i = 0; i < collection.length; i++) {
          if (collection[i].type == type) {
            result.push(collection[i]);
          }
        }
        return result;
      }

      //注油
      function oilInput(groupObj, clonum, time) {
        var refObj = groupObj.element[1]; //参照物
        var svgObj = groupObj.element[2];

        svgObj.animate(
          {
            fill: colors[clonum]
          },
          0,
          mina.bounce
        );

        var locations = refObj.getBBox();
        var old_x = locations.x;
        var old_y = locations.y;
        var old_width = locations.width;
        var old_height = locations.height;

        Snap.animate(
          old_y + old_height,
          old_y,
          function(val) {
            svgObj.attr({
              y: val,
              height: old_y + old_height - val
            });
          },
          time
        );
      }

      //抽油
      function oilOutput(groupObj, oil_type, time) {
        var refObj = groupObj.element[1]; //参照物
        var svgObj = groupObj.element[2];

        svgObj.animate(
          {
            fill: colors[oil_type]
          },
          0,
          mina.bounce
        );

        var locations = refObj.getBBox();
        var old_x = locations.x;
        var old_y = locations.y;
        var old_width = locations.width;
        var old_height = locations.height;

        Snap.animate(
          old_y,
          old_y + old_height,
          function(val) {
            svgObj.attr({
              y: val,
              height: old_y + old_height - val
            });
          },
          time
        );
      }

      var rt = 4; //驻留时间
      var svg = Snap("#svg");
      var collection = [];
      var fp = getRenderObject(svg, "fp", 50, 0, 90, 75);
      var tank = getRenderObject(svg, "tank", 50, 50, 90, 125);
      var ds = getRenderObject(svg, "ds", 100, 200, 160, 300);
      var pipe = getRenderObject(svg, "pipe", 40, 12, 540, 20);
      collection.push(fp);
      collection.push(tank);
      collection.push(ds);
      collection.push(pipe);
      var global_clock = svg.paper.text(1100, 650, "系统时间：0");

      //FP2~11
      var offset = 95;
      for (i = 1; i <= 10; i++) {
        var tmp = i * offset;
        var cloneObj = cloneRenderObject(svg, fp);
        moveRenderObject(cloneObj, tmp, 0);
        collection.push(cloneObj);
      }

      //TK2~11
      var offset = 95;
      for (i = 1; i <= 10; i++) {
        var tmp = i * offset;
        var cloneObj = cloneRenderObject(svg, tank); //复制
        moveRenderObject(cloneObj, tmp, 0); //平移
        collection.push(cloneObj);
      }

      //pipe2
      var pipe2 = cloneRenderObject(svg, pipe);
      moveRenderObject(pipe2, 0, 205);
      collection.push(pipe2);

      //DS2~DS4
      var offset = 225;
      for (i = 1; i <= 3; i++) {
        var tmp = i * offset;
        var cloneObj = cloneRenderObject(svg, ds); //复制
        moveRenderObject(cloneObj, tmp, 0); //平移
        collection.push(cloneObj);
      }

      //获取group对象
      var tanks = selectObjectsByType(collection, "tank");
      var dss = selectObjectsByType(collection, "ds");
      var pipes = selectObjectsByType(collection, "pipe");
      var fps = selectObjectsByType(collection, "fp");

      for (i = 0; i < fps.length; i++) {
        moveRenderObject(fps[i], 5, 50);
      }
      for (i = 0; i < tanks.length; i++) {
        moveRenderObject(tanks[i], 5, 155);
      }
      for (i = 0; i < pipes.length; i++) {
        moveRenderObject(pipes[i], 40, 195);
      }
      for (i = 0; i < dss.length; i++) {
        moveRenderObject(dss[i], 0, 60);
      }

      //事件
      document.getElementById("button1").onclick = function() {
        for (i = 0; i < data.length; i++) {
          var line = data[i];
          var arr = line.split(" ");

          var ds_num = (parseFloat(arr[0]) * 10000).toFixed(2);
          var tank_num = (parseFloat(arr[1]) * 10000).toFixed(2);
          var start_time = (parseFloat(arr[2]) * 10000).toFixed(2);
          var end_time = (parseFloat(arr[3]) * 10000).toFixed(2);
          var oil_type = (parseFloat(arr[4]) * 10000).toFixed(2);
          //var vol = (parseFloat(arr[6]) * 10000).toFixed(2);//原油体积

          if (tank_num == 0) {
            continue; //停运
          } else {
            if (ds_num > 4) {
              var dur = (end_time - start_time) * 1000;
              var start = start_time * 1000;
              var end = end_time * 1000;
              startOutput("fp", oil_type, start, oil_type, dur);
              startInput("tank", tank_num, start, oil_type, dur);
              changeTankState(tank_num, 1, start); //占用
              changeTankState(tank_num, 2, end); //等待
              changeTankState(tank_num, 3, end + rt * 1000); //满
              updateFPState(ds_num, oil_type, start, end);
            } else {
              var dur = (end_time - start_time) * 1000;
              var start = start_time * 1000;
              var end = end_time * 1000;
              startOutput("tank", tank_num, start, oil_type, dur);
              startInput("ds", ds_num, start, oil_type, dur);
              changeTankState(tank_num, 1, start); //占用
              changeTankState(tank_num, 0, end); //空
              updateDSState(ds_num, start, end);
            }
          }
        }
        var int = self.setInterval("clock()", 1000);
      };

      //更新计时
      function clock() {
        t = t + 1;
        global_clock.node.textContent = "系统时间：" + t;
      }

      //封装setTimeout延时方法，避免循环问题
      function startOutput(type, num, start, oil_type, dur) {
        window.setTimeout(function() {
          if (type == "fp") {
            var obj = fps[num - 1];
            oilOutput(obj, oil_type - 1, dur);
          } else if (type == "tank") {
            var obj = tanks[num - 1];
            oilOutput(obj, oil_type - 1, dur);
          } else if (type == "ds") {
            var obj = dss[num - 1];
            oilOutput(obj, oil_type - 1, dur);
          } else {
            console.log("类型错误!");
          }
        }, start);
      }

      //封装setTimeout延时方法，避免循环问题
      function startInput(type, num, start, oil_type, dur) {
        window.setTimeout(function() {
          if (type == "fp") {
            var obj = fps[num - 1];
            oilInput(obj, oil_type - 1, dur);
          } else if (type == "tank") {
            var obj = tanks[num - 1];
            oilInput(obj, oil_type - 1, dur);
          } else if (type == "ds") {
            var obj = dss[num - 1];
            oilInput(obj, oil_type - 1, dur);
          } else {
            console.log("类型错误!");
          }
        }, start);
      }

      //延时一定时间后改变油罐的状态
      function changeTankState(num, state, start) {
        window.setTimeout(function() {
          var obj = tanks[num - 1].element[8];
          if (state == 0) {
            //黑色(空罐)
            obj.attr({
              fill: "black"
            });
          } else if (state == 1) {
            //红色(占用，正在注油或者正在抽油)
            obj.attr({
              fill: "red"
            });
          } else if (state == 2) {
            //黄色(等待驻留时间)
            obj.attr({
              fill: "yellow"
            });
          } else if (state == 3) {
            //绿色(准备好原油)
            obj.attr({
              fill: "green"
            });
          }
        }, start);
      }

      //更新塔的状态
      function updateDSState(num, start, end) {
        window.setTimeout(function() {
          var obj = dss[num - 1].element[6];
          //红色(工作)
          obj.attr({
            fill: "red"
          });
        }, start);
        window.setTimeout(function() {
          var obj = dss[num - 1].element[6];
          //黑色(未工作)
          obj.attr({
            fill: "black"
          });
        }, end);
      }

      //更新管道的状态
      function updateFPState(ds_num, oil_type, start, end) {
        window.setTimeout(function() {
          var obj = fps[oil_type - 1].element[3];
          obj.node.textContent = "Pipe " + (ds_num - 4);
        }, start);
        window.setTimeout(function() {
          var obj = fps[oil_type - 1].element[3];
          obj.node.textContent = "";
        }, end);
      }
    </script>
  </body>
</html>
