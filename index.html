<!DOCTYPE html>
<html>
  <head>
    <title>原油调度图</title>
    <!--引用-->
    <script
      src="js/snap.svg.js"
      type="text/javascript"
      charset="utf-8"
    ></script>
  </head>

  <body>
    <div style="float: right;">
      <input id="button1" type="button" class="zxx_api_button" value="开始" />
      <input id="button2" type="button" class="zxx_api_button" value="暂停" />
      <input id="button3" type="button" class="zxx_api_button" value="继续" />
    </div>
    <div style="float:left;">
      <svg id="svg" width="1200" height="700"></svg>
    </div>
    <script>
      var data = [
        "0.0002 0.0002 0 0.0048 0.0001 0 1.6000",
        "0.0002 0.0003 0.0048 0.0126 0.0002 0 2.6000",
        "0.0001 0.0005 0 0.0100 0.0003 0 2.5000",
        "0.0003 0.0006 0 0.0060 0.0005 0 1.5000",
        "0.0003 0.0007 0.0060 0.0128 0.0004 0 1.7000", //"0.0006 0.0008 0 0.0040 0.0006 0 2.5000",预备阶段
        "0.0006 0.0008 0.0040 0.0069 0.0006 0 1.8000",
        "0.0003 0.0008 0.0128 0.0200 0.0006 0 1.8000",
        "0.0004 0.0009 0 0.0035 0.0007 0 2.2000",
        "0.0004 0.0010 0.0035 0.0066 0.0008 0 1.9000",
        "0.0006 0.0001 0.0069 0.0116 0.0011 0.0003 2.0000",
        "0.0002 0.0001 0.0126 0.0186 0.0011 0.0002 2.0000",
        "0.0006 0.0002 0.0116 0.0182 0.0011 0.0003 2.7388",
        "0.0002 0.0002 0.0186 0.0268 0.0011 0.0002 2.7388",
        "0.0006 0.0003 0.0182 0.0258 0.0011 0.0001 3.1897",
        "0.0002 0.0003 0.0268 0.0363 0.0011 0.0002 3.1897",
        "0.0005 0.0004 0 0.0017 0.0004 0.0003 2.4000",
        "0.0001 0.0004 0.0100 0.0196 0.0004 0.0003 2.4000",
        "0.0005 0.0011 0.0017 0.0041 0.0008 0.0001 2.0000 ",
        "0.0004 0.0011 0.0066 0.0098 0.0008 0.0001 2.0000",
        "0.0005 0.0009 0.0041 0.0082 0.0008 0.0001 3.4000",
        "0.0004 0.0009 0.0098 0.0152 0.0008 0.0001 3.4000",
        "0.0005 0.0006 0.0082 0.0123 0.0008 0.0001 3.4000",
        "0.0001 0.0006 0.0196 0.0332 0.0008 0.0001 3.4000",
        "0.0005 0.0005 0.0123 0.0131 0.0008 0.0002 1.0055",
        "0.0001 0.0005 0.0332 0.0372 0.0008 0.0002 1.0055",
        "0.0005 0.0011 0.0131 0.0144 0.0008 0.0002 1.6122",
        "0.0004 0.0011 0.0152 0.0178 0.0008 0.0002 1.6122",
        "0.0005 0.0007 0.0144 0.0155 0.0008 0.0002 1.3878",
        "0.0004 0.0007 0.0178 0.0200 0.0008 0.0002 1.3878",
        "0.0005 0.0009 0.0155 0.0192 0.0009 0.0001 3.0747",
        "0.0004 0.0009 0.0200 0.0249 0.0009 0.0001 3.0747",
        "0.0005 0.0001 0.0192 0.0208 0.0010 0.0002 2.0000",
        "0.0003 0.0001 0.0200 0.0280 0.0010 0.0002 2.0000",
        "0.0005 0.0004 0.0208 0.0238 0.0009 0.0001 2.5000",
        "0.0004 0.0004 0.0249 0.0289 0.0009 0.0001 2.5000",
        "0.0005 0.0011 0.0238 0.0253 0.0009 0.0003 2.0000",
        "0.0004 0.0011 0.0289 0.0321 0.0009 0.0003 2.0000",
        "0.0005 0.0007 0.0253 0.0269 0.0010 0.0002 2.0000",
        "0.0003 0.0007 0.0280 0.0360 0.0010 0.0002 2.0000",
        "0.0005 0.0009 0.0269 0.0271 0.0010 0.0003 0.3055",
        "0.0003 0.0009 0.0360 0.0372 0.0010 0.0003 0.3055",
        "0.0005 0.0002 0.0271 0.0309 0.0009 0.0001 3.1891",
        "0.0004 0.0002 0.0321 0.0372 0.0009 0.0001 3.1891"
      ];

      var colors = [
        "#f05b72",
        "#905a3d",
        "#f58220",
        "#7fb80e",
        "#494e8f",
        "#aa363d",
        "#8552a1",
        "#aa2116",
        "#dea32c",
        "#73b9a2",
        "#ba8448",
        "#f15a22"
      ];

      //绘制储油罐
      function renderFP(svg, x, y, width, height) {
        var d = 5; //塔口直径
        var len = 20; //塔口长度
        var t = 5; //塔的厚度
        var d1 = svg.paper.rect(x, y, width, height, 10).attr({
          fill: "grey"
        });
        var d2 = svg.paper
          .rect(x + t, y + t, width - 2 * t, height - 2 * t, 10)
          .attr({
            fill: "white"
          });
        var d3 = svg.paper
          .rect(x + t, y + t, width - 2 * t, height - 2 * t, 10)
          .attr({
            fill: "white"
          });
        var e = svg.paper
          .line(x + width / 2, y + height, x + width / 2, y + height + len)
          .attr({
            stroke: "#000",
            strokeWidth: 5
          });
        var tag = svg.paper.text(
          x + (width - d) / 2 + 10,
          y + height + 12,
          "  "
        );
        //每个罐的容量按照50000计算
        var step_length = (height - 2 * t) / 5;
        var scale1 = svg.paper
          .line(
            x + width - 15,
            y + step_length + t,
            x + width - 5,
            y + step_length + t
          )
          .attr({
            stroke: "#000",
            strokeWidth: 1
          });
        var scale2 = svg.paper
          .line(
            x + width - 15,
            y + step_length * 2 + t,
            x + width - 5,
            y + step_length * 2 + t
          )
          .attr({
            stroke: "#000",
            strokeWidth: 1
          });
        var scale3 = svg.paper
          .line(
            x + width - 15,
            y + step_length * 3 + t,
            x + width - 5,
            y + step_length * 3 + t
          )
          .attr({
            stroke: "#000",
            strokeWidth: 1
          });
        var scale4 = svg.paper
          .line(
            x + width - 15,
            y + step_length * 4 + t,
            x + width - 5,
            y + step_length * 4 + t
          )
          .attr({
            stroke: "#000",
            strokeWidth: 1
          });
        return svg.paper
          .g(d1, d2, d3, tag, e, scale1, scale2, scale3, scale4)
          .data("t", t); // 存储罐的厚度
      }

      //绘制油罐
      function renderTank(svg, x, y, width, height) {
        var d = 5; //罐口直径
        var len = 20; //罐口长度
        var t = 5; //罐的厚度
        var c1 = svg.paper.rect(x, y, width, height, 10).attr({
          fill: "grey"
        });
        var c2 = svg.paper
          .rect(x + t, y + t, width - 2 * t, height - 2 * t, 10)
          .attr({
            fill: "white"
          });
        var c3 = svg.paper
          .rect(x + t, y + t, width - 2 * t, height - 2 * t, 10)
          .attr({
            fill: "white"
          });
        var l1 = svg.paper.line(x + width / 2, y - len, x + width / 2, y).attr({
          stroke: "#000",
          strokeWidth: d
        });
        var l2 = svg.paper
          .line(x + width / 2, y + height, x + width / 2, y + height + len)
          .attr({
            stroke: "#000",
            strokeWidth: d
          });
        var t1 = svg.paper.text(x + (width - d) / 2 + 10, y, " ");
        var t2 = svg.paper.text(x + (width - d) / 2 + 10, y + height + 12, " ");
        var circle1 = svg.paper
          .circle(x + (width - d) / 2 - 10, y + height + 9, 7)
          .attr({
            fill: "gray"
          });
        var circle2 = svg.paper
          .circle(x + (width - d) / 2 - 10, y + height + 9, 5)
          .attr({
            fill: "black"
          });

        //每个罐的容量按照50000计算
        var step_length = (height - 2 * t) / 5;
        var scale1 = svg.paper
          .line(
            x + width - 15,
            y + step_length + t,
            x + width - 5,
            y + step_length + t
          )
          .attr({
            stroke: "#000",
            strokeWidth: 1
          });
        var scale2 = svg.paper
          .line(
            x + width - 15,
            y + step_length * 2 + t,
            x + width - 5,
            y + step_length * 2 + t
          )
          .attr({
            stroke: "#000",
            strokeWidth: 1
          });
        var scale3 = svg.paper
          .line(
            x + width - 15,
            y + step_length * 3 + t,
            x + width - 5,
            y + step_length * 3 + t
          )
          .attr({
            stroke: "#000",
            strokeWidth: 1
          });
        var scale4 = svg.paper
          .line(
            x + width - 15,
            y + step_length * 4 + t,
            x + width - 5,
            y + step_length * 4 + t
          )
          .attr({
            stroke: "#000",
            strokeWidth: 1
          });
        return svg.paper
          .g(
            c1,
            c2,
            c3,
            t1,
            t2,
            l1,
            l2,
            circle1,
            circle2,
            scale1,
            scale2,
            scale3,
            scale4
          )
          .data("t", t); // 存储罐的厚度
      }

      //绘制蒸馏塔
      function renderDS(svg, x, y, width, height) {
        var d = 5; //塔口直径
        var len = 20; //塔口长度
        var t = 5; //塔的厚度
        var d1 = svg.paper.rect(x, y, width, height, 10).attr({
          fill: "grey"
        });
        var d2 = svg.paper
          .rect(x + t, y + t, width - 2 * t, height - 2 * t, 10)
          .attr({
            fill: "white"
          });
        var d3 = svg.paper
          .rect(x + t, y + t, width - 2 * t, height - 2 * t, 10)
          .attr({
            fill: "white"
          });
        var e = svg.paper.line(x + width / 2, y - len, x + width / 2, y).attr({
          stroke: "#000",
          strokeWidth: 5
        });
        var tag = svg.paper.text(x + (width - d) / 2 + 10, y, " ");
        var circle1 = svg.paper
          .circle(x + (width - d) / 2 - 10, y - 8, 7)
          .attr({
            fill: "gray"
          });
        var circle2 = svg.paper
          .circle(x + (width - d) / 2 - 10, y - 8, 5)
          .attr({
            fill: "black"
          });
        //每个罐的容量按照50000计算
        var step_length = (height - 2 * t) / 5;
        var scale1 = svg.paper
          .line(
            x + width - 15,
            y + step_length + t,
            x + width - 5,
            y + step_length + t
          )
          .attr({
            stroke: "#000",
            strokeWidth: 1
          });
        var scale2 = svg.paper
          .line(
            x + width - 15,
            y + step_length * 2 + t,
            x + width - 5,
            y + step_length * 2 + t
          )
          .attr({
            stroke: "#000",
            strokeWidth: 1
          });
        var scale3 = svg.paper
          .line(
            x + width - 15,
            y + step_length * 3 + t,
            x + width - 5,
            y + step_length * 3 + t
          )
          .attr({
            stroke: "#000",
            strokeWidth: 1
          });
        var scale4 = svg.paper
          .line(
            x + width - 15,
            y + step_length * 4 + t,
            x + width - 5,
            y + step_length * 4 + t
          )
          .attr({
            stroke: "#000",
            strokeWidth: 1
          });
        return svg.paper
          .g(
            d1,
            d2,
            d3,
            tag,
            e,
            circle1,
            circle2,
            scale1,
            scale2,
            scale3,
            scale4
          )
          .data("t", t); // 存储罐的厚度
      }

      //绘制管道
      function renderPipe(svg, x, y, width, height) {
        var bus1 = svg.paper.line(x, y, x + width, y).attr({
          stroke: "#000",
          strokeWidth: 5
        });
        var bus2 = svg.paper
          .line(x + width / 2, y, x + width / 2, y + height)
          .attr({
            stroke: "#000",
            strokeWidth: 10
          });
        var bus3 = svg.paper.line(x, y + height, x + width, y + height).attr({
          stroke: "#000",
          strokeWidth: 5
        });
        return svg.paper.g(bus1, bus2, bus3);
      }

      //该方法主要是为了简化旋转操作
      function renderObject(svg, type, x, y, centX, centY) {
        var result = {};
        var width = (centX - x) * 2;
        var height = (centY - y) * 2;

        if (type == "tank") {
          result.element = renderTank(svg, x, y, width, height);
        } else if (type == "ds") {
          result.element = renderDS(svg, x, y, width, height);
        } else if (type == "pipe") {
          result.element = renderPipe(svg, x, y, width, height);
        } else if (type == "fp") {
          result.element = renderFP(svg, x, y, width, height);
        }

        result.type = type;
        result.x = x;
        result.y = y;
        result.centX = x + width / 2;
        result.centY = y + height / 2;
        return result;
      }

      //复制对象(和原始对象重叠)
      function cloneRenderObject(svg, obj) {
        return renderObject(svg, obj.type, obj.x, obj.y, obj.centX, obj.centY); //obj.element.clone();
      }

      //移动
      function moveRenderObject(obj, right, down) {
        var m = new Snap.Matrix();
        m.translate(obj.x + right, obj.y + down);
        obj.element.transform(m);
        obj.x = obj.x + right;
        obj.y = obj.y + down;
        obj.centX = obj.centX + right;
        obj.centY = obj.centY + down;
      }

      //按照类型查找对象
      function selectObjectsByType(collection, type) {
        var result = [];
        for (i = 0; i < collection.length; i++) {
          if (collection[i].type == type) {
            result.push(collection[i]);
          }
        }
        return result;
      }

      //注油
      function oilInput(groupObj, oil_type, time, vol) {
        var refObj = groupObj.element[1]; //参照物
        var svgObj = groupObj.element[2];

        svgObj.attr({
          fill: colors[oil_type - 1]
        });

        var locations = refObj.getBBox();
        var old_x = locations.x;
        var old_y = locations.y;
        var old_width = locations.width;
        var old_height = locations.height;
        var new_height = old_height * (vol / 50000);

        Snap.animate(
          old_y + old_height,
          old_y + old_height - new_height,
          function(val) {
            svgObj.attr({
              y: val,
              height: old_y + old_height - val
            });
            if (val == old_y + old_height - new_height) {
              log();
            }
          },
          time
        );
      }

      //抽油
      function oilOutput(groupObj, oil_type, time, vol) {
        var refObj = groupObj.element[1]; //参照物
        var svgObj = groupObj.element[2];

        svgObj.attr({
          fill: colors[oil_type - 1]
        });

        var locations = refObj.getBBox();
        var old_x = locations.x;
        var old_y = locations.y;
        var old_width = locations.width;
        var old_height = locations.height;
        var new_height = old_height * (vol / 50000);

        Snap.animate(
          old_y + old_height - new_height,
          old_y + old_height,
          function(val) {
            svgObj.attr({
              y: val,
              height: old_y + old_height - val
            });
            if (val == old_y + old_height) {
              log();
            }
          },
          time
        );
      }

      var rt = 4; //驻留时间
      var svg = Snap("#svg");
      var collection = [];
      var fp = renderObject(svg, "fp", 50, 0, 90, 75);
      var tank = renderObject(svg, "tank", 50, 50, 90, 125);
      var ds = renderObject(svg, "ds", 100, 200, 160, 300);
      var pipe = renderObject(svg, "pipe", 40, 12, 540, 20);
      collection.push(fp);
      collection.push(tank);
      collection.push(ds);
      collection.push(pipe);

      //FP2~11
      var offset = 95;
      for (i = 1; i <= 10; i++) {
        var tmp = i * offset;
        var cloneObj = cloneRenderObject(svg, fp);
        moveRenderObject(cloneObj, tmp, 0);
        collection.push(cloneObj);
      }

      //TK2~11
      var offset = 95;
      for (i = 1; i <= 10; i++) {
        var tmp = i * offset;
        var cloneObj = cloneRenderObject(svg, tank); //复制
        moveRenderObject(cloneObj, tmp, 0); //平移
        collection.push(cloneObj);
      }

      //pipe2
      var pipe2 = cloneRenderObject(svg, pipe);
      moveRenderObject(pipe2, 0, 205);
      collection.push(pipe2);

      //DS2~DS4
      var offset = 225;
      for (i = 1; i <= 3; i++) {
        var tmp = i * offset;
        var cloneObj = cloneRenderObject(svg, ds); //复制
        moveRenderObject(cloneObj, tmp, 0); //平移
        collection.push(cloneObj);
      }

      //获取group对象
      var tanks = selectObjectsByType(collection, "tank");
      var dss = selectObjectsByType(collection, "ds");
      var pipes = selectObjectsByType(collection, "pipe");
      var fps = selectObjectsByType(collection, "fp");

      for (i = 0; i < fps.length; i++) {
        moveRenderObject(fps[i], 5, 50);
      }
      for (i = 0; i < tanks.length; i++) {
        moveRenderObject(tanks[i], 5, 155);
      }
      for (i = 0; i < pipes.length; i++) {
        moveRenderObject(pipes[i], 40, 195);
      }
      for (i = 0; i < dss.length; i++) {
        moveRenderObject(dss[i], 0, 60);
      }

      //事件
      document.getElementById("button1").onclick = function() {
        for (i = 0; i < data.length; i++) {
          var line = data[i];
          var arr = line.split(" ");

          var ds_num = (parseFloat(arr[0]) * 10000).toFixed(2);
          var tank_num = (parseFloat(arr[1]) * 10000).toFixed(2);
          var start_time = (parseFloat(arr[2]) * 10000).toFixed(2);
          var end_time = (parseFloat(arr[3]) * 10000).toFixed(2);
          var oil_type = (parseFloat(arr[4]) * 10000).toFixed(2);
          var speed = parseInt(arr[5] * 10000);
          var vol = (parseFloat(arr[6]) * 10000).toFixed(2); //原油体积

          if (tank_num == 0) {
            continue; //停运
          } else {
            if (ds_num > 4) {
              var dur = (end_time - start_time) * 1000;
              var start = start_time * 1000;
              var end = end_time * 1000;
              startOutput("fp", oil_type, start, oil_type, dur, vol);
              startInput("tank", tank_num, start, oil_type, dur, vol);
              changeTankState(ds_num, tank_num, 1, start); //占用
              changeTankState(ds_num, tank_num, 2, end); //等待
              changeTankState(ds_num, tank_num, 3, end + rt * 1000); //满
              updateFPState(ds_num, oil_type, start, end);
              updateTankState(ds_num, tank_num, start, end);
            } else {
              //初始库存，则更新供油罐中原油量
              if (speed == 0) {
                updateInitOil(tank_num, oil_type, vol);
                changeTankState(ds_num, tank_num, 3, 0); //满
              }
              var dur = (end_time - start_time) * 1000;
              var start = start_time * 1000;
              var end = end_time * 1000;
              startOutput("tank", tank_num, start, oil_type, dur, vol);
              startInput("ds", ds_num, start, oil_type, dur, vol);
              changeTankState(ds_num, tank_num, 1, start); //占用
              changeTankState(ds_num, tank_num, 0, end); //空
              updateDSState(ds_num, oil_type, start, end);
              updateTankState(ds_num, tank_num, start, end);
            }
          }
        }
      };

      //日志记录
      function log() {
        alert("ok");
      }

      //渲染初始时仓库中原油
      function updateInitOil(tank_num, oil_type, vol) {
        var refObj = tanks[tank_num - 1].element[1]; //参照物
        var svgObj = tanks[tank_num - 1].element[2];
        var ledObj = tanks[tank_num - 1].element[2]; //led

        var locations = refObj.getBBox();
        var old_x = locations.x;
        var old_y = locations.y;
        var old_width = locations.width;
        var old_height = locations.height;
        var new_height = old_height * (vol / 50000);

        svgObj.attr({
          fill: colors[oil_type - 1],
          y: old_y + old_height - new_height,
          height: new_height
        });
      }

      //封装setTimeout延时方法，避免循环问题
      function startOutput(type, num, start, oil_type, dur, vol) {
        window.setTimeout(function() {
          if (type == "fp") {
            var obj = fps[num - 1];
            oilOutput(obj, oil_type, dur, vol);
          } else if (type == "tank") {
            var obj = tanks[num - 1];
            oilOutput(obj, oil_type, dur, vol);
          } else if (type == "ds") {
            var obj = dss[num - 1];
            oilOutput(obj, oil_type, dur, vol);
          } else {
            console.log("类型错误!");
          }
        }, start);
      }

      //封装setTimeout延时方法，避免循环问题
      function startInput(type, num, start, oil_type, dur, vol) {
        window.setTimeout(function() {
          if (type == "fp") {
            var obj = fps[num - 1];
            oilInput(obj, oil_type, dur, vol);
          } else if (type == "tank") {
            var obj = tanks[num - 1];
            oilInput(obj, oil_type, dur, vol);
          } else if (type == "ds") {
            var obj = dss[num - 1];
            oilInput(obj, oil_type, dur, vol);
          } else {
            console.log("类型错误!");
          }
        }, start);
      }

      //延时一定时间后改变油罐的状态
      function changeTankState(ds_num, tank_num, state, start) {
        window.setTimeout(function() {
          var obj = tanks[tank_num - 1].element[8];
          if (state == 0) {
            //黑色(空罐)
            obj.attr({
              fill: "black"
            });
          } else if (state == 1) {
            //红色(占用，正在注油或者正在抽油)
            obj.attr({
              fill: "red"
            });
          } else if (state == 2) {
            //黄色(等待驻留时间)
            obj.attr({
              fill: "yellow"
            });
          } else if (state == 3) {
            //绿色(准备好原油)
            obj.attr({
              fill: "green"
            });
          }
        }, start);
      }

      //更新罐的状态
      function updateTankState(ds_num, tank_num, start, end) {
        if (ds_num > 4) {
          window.setTimeout(function() {
            var obj = tanks[tank_num - 1].element[3];
            obj.node.textContent = "Pipe " + (ds_num - 4).toFixed();
          }, start);
          window.setTimeout(function() {
            var obj = tanks[tank_num - 1].element[3];
            obj.node.textContent = "  ";
          }, end);
        } else {
          window.setTimeout(function() {
            var obj = tanks[tank_num - 1].element[4];
            obj.node.textContent = "DS " + parseInt(ds_num);
          }, start);
          window.setTimeout(function() {
            var obj = tanks[tank_num - 1].element[4];
            obj.node.textContent = " ";
          }, end);
        }
      }

      //更新塔的状态
      function updateDSState(num, oil_type, start, end) {
        window.setTimeout(function() {
          var obj = dss[num - 1].element[6];
          //红色(工作)
          obj.attr({
            fill: "red"
          });
          var obj = dss[num - 1].element[3];
          obj.node.textContent = "# " + parseInt(oil_type);
        }, start);
        window.setTimeout(function() {
          var obj = dss[num - 1].element[6];
          //黑色(未工作)
          obj.attr({
            fill: "black"
          });
          var obj = dss[num - 1].element[3];
          obj.node.textContent = " ";
        }, end);
      }

      //更新管道的状态
      function updateFPState(ds_num, oil_type, start, end) {
        window.setTimeout(function() {
          var obj = fps[oil_type - 1].element[3];
          obj.node.textContent = "Pipe " + (ds_num - 4);
        }, start);
        window.setTimeout(function() {
          var obj = fps[oil_type - 1].element[3];
          obj.node.textContent = "";
        }, end);
      }
    </script>
  </body>
</html>
